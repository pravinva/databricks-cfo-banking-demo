# Task: WS6-02 Interactive Drill-Down Capabilities for React Frontend

## Environment Status
✅ Working directory: ~/Documents/Demo/databricks-cfo-banking-demo
✅ Databricks: e2-demo-field-eng.cloud.databricks.com
✅ SQL Warehouse: 4b9b953939869799

## Previous Tasks Status
✅ WS6-01 Complete - React frontend built
✅ WS5-01 Complete - Lakeview dashboards created

## Task Objective
Add comprehensive drill-down capabilities to the React frontend. Every visualization, table, and metric should be clickable and allow users to explore underlying data interactively.

## Drill-Down Architecture

**User Journey Example:**
```
Executive Dashboard
  ↓ (click "Recent Activity")
Activity Detail View
  ↓ (filter: Auto Loans)
Auto Loan List (48,000 loans)
  ↓ (click specific loan: LOAN-AUTO-012345)
Loan Detail Panel
  ├─ Loan information
  ├─ Payment history
  ├─ GL entries for this loan
  ├─ CECL calculation breakdown
  └─ Subledger transactions
```

**Every level is interactive and data-driven.**

## Instructions

### 1. Create Drill-Down State Management

```typescript
// lib/drill-down-context.tsx
'use client'

import { createContext, useContext, useState, ReactNode } from 'react'

interface DrillDownState {
  view: string
  filters: Record<string, any>
  breadcrumbs: Array<{ label: string; view: string; filters: any }>
}

interface DrillDownContextType {
  state: DrillDownState
  navigateTo: (view: string, filters?: any, label?: string) => void
  navigateBack: () => void
  reset: () => void
}

const DrillDownContext = createContext<DrillDownContextType | undefined>(undefined)

export function DrillDownProvider({ children }: { children: ReactNode }) {
  const [state, setState] = useState<DrillDownState>({
    view: 'dashboard',
    filters: {},
    breadcrumbs: [{ label: 'Dashboard', view: 'dashboard', filters: {} }]
  })
  
  const navigateTo = (view: string, filters: any = {}, label: string = view) => {
    setState(prev => ({
      view,
      filters,
      breadcrumbs: [...prev.breadcrumbs, { label, view, filters }]
    }))
  }
  
  const navigateBack = () => {
    setState(prev => {
      if (prev.breadcrumbs.length <= 1) return prev
      
      const newBreadcrumbs = prev.breadcrumbs.slice(0, -1)
      const lastCrumb = newBreadcrumbs[newBreadcrumbs.length - 1]
      
      return {
        view: lastCrumb.view,
        filters: lastCrumb.filters,
        breadcrumbs: newBreadcrumbs
      }
    })
  }
  
  const reset = () => {
    setState({
      view: 'dashboard',
      filters: {},
      breadcrumbs: [{ label: 'Dashboard', view: 'dashboard', filters: {} }]
    })
  }
  
  return (
    <DrillDownContext.Provider value={{ state, navigateTo, navigateBack, reset }}>
      {children}
    </DrillDownContext.Provider>
  )
}

export const useDrillDown = () => {
  const context = useContext(DrillDownContext)
  if (!context) throw new Error('useDrillDown must be used within DrillDownProvider')
  return context
}
```

### 2. Create Breadcrumb Navigation Component

```typescript
// components/Breadcrumbs.tsx
'use client'

import { ChevronRight, Home } from 'lucide-react'
import { useDrillDown } from '@/lib/drill-down-context'
import { motion } from 'framer-motion'

export default function Breadcrumbs() {
  const { state, navigateBack, reset } = useDrillDown()
  
  if (state.breadcrumbs.length <= 1) return null
  
  return (
    <div className="flex items-center gap-2 mb-6 text-sm">
      <button
        onClick={reset}
        className="flex items-center gap-1 text-slate-600 hover:text-primary-600 transition-colors"
      >
        <Home className="h-4 w-4" />
      </button>
      
      {state.breadcrumbs.map((crumb, index) => (
        <div key={index} className="flex items-center gap-2">
          <ChevronRight className="h-4 w-4 text-slate-400" />
          
          <button
            onClick={() => {
              // Navigate to this level
              if (index < state.breadcrumbs.length - 1) {
                for (let i = 0; i < state.breadcrumbs.length - index - 1; i++) {
                  navigateBack()
                }
              }
            }}
            className={`${
              index === state.breadcrumbs.length - 1
                ? 'text-slate-900 font-medium'
                : 'text-slate-600 hover:text-primary-600'
            } transition-colors`}
          >
            {crumb.label}
          </button>
        </div>
      ))}
    </div>
  )
}
```

### 3. Create Interactive Loan Table with Drill-Down

```typescript
// components/tables/LoanTable.tsx
'use client'

import { useState, useEffect } from 'react'
import { useDrillDown } from '@/lib/drill-down-context'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { ChevronRight, Filter } from 'lucide-react'
import { motion } from 'framer-motion'

interface Loan {
  loan_id: string
  product_type: string
  current_balance: number
  interest_rate: number
  payment_status: string
  borrower_name: string
  origination_date: string
}

export default function LoanTable({ filters = {} }) {
  const [loans, setLoans] = useState<Loan[]>([])
  const [loading, setLoading] = useState(true)
  const { navigateTo } = useDrillDown()
  
  useEffect(() => {
    // Fetch loans with filters
    const queryParams = new URLSearchParams()
    
    if (filters.product_type) {
      queryParams.append('product_type', filters.product_type)
    }
    if (filters.days) {
      queryParams.append('days', filters.days.toString())
    }
    
    fetch(`/api/data/loans?${queryParams}`)
      .then(res => res.json())
      .then(data => {
        setLoans(data.loans)
        setLoading(false)
      })
  }, [filters])
  
  const handleLoanClick = (loan: Loan) => {
    // Drill down to loan detail
    navigateTo('loan-detail', { loan_id: loan.loan_id }, `Loan ${loan.loan_id}`)
  }
  
  const getStatusColor = (status: string) => {
    const colors: Record<string, string> = {
      'Current': 'bg-green-100 text-green-800 border-green-200',
      'Past_Due_30': 'bg-yellow-100 text-yellow-800 border-yellow-200',
      'Past_Due_60': 'bg-orange-100 text-orange-800 border-orange-200',
      'Past_Due_90': 'bg-red-100 text-red-800 border-red-200',
      'Default': 'bg-red-200 text-red-900 border-red-300'
    }
    return colors[status] || 'bg-slate-100 text-slate-800'
  }
  
  if (loading) {
    return <div className="animate-pulse">Loading loans...</div>
  }
  
  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2 text-sm text-slate-600">
          <Filter className="h-4 w-4" />
          <span>{loans.length.toLocaleString()} loans</span>
          {filters.product_type && (
            <Badge variant="outline">
              {filters.product_type}
            </Badge>
          )}
        </div>
        
        {/* Product type filter buttons */}
        <div className="flex gap-2">
          {['C&I', 'Commercial_RE', 'Residential_Mortgage', 'Consumer_Auto'].map(type => (
            <button
              key={type}
              onClick={() => {
                navigateTo('loan-table', { product_type: type }, `${type} Loans`)
              }}
              className={`text-xs px-3 py-1.5 rounded-md border transition-colors ${
                filters.product_type === type
                  ? 'bg-primary-500 text-white border-primary-500'
                  : 'bg-white text-slate-700 border-slate-300 hover:border-primary-500'
              }`}
            >
              {type.replace('_', ' ')}
            </button>
          ))}
        </div>
      </div>
      
      {/* Table */}
      <div className="border border-slate-200 rounded-lg overflow-hidden">
        <Table>
          <TableHeader>
            <TableRow className="bg-slate-50">
              <TableHead>Loan ID</TableHead>
              <TableHead>Borrower</TableHead>
              <TableHead>Product</TableHead>
              <TableHead className="text-right">Balance</TableHead>
              <TableHead className="text-right">Rate</TableHead>
              <TableHead>Status</TableHead>
              <TableHead>Originated</TableHead>
              <TableHead></TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {loans.map((loan, index) => (
              <motion.tr
                key={loan.loan_id}
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ delay: index * 0.02 }}
                onClick={() => handleLoanClick(loan)}
                className="cursor-pointer hover:bg-slate-50 transition-colors border-b border-slate-100"
              >
                <TableCell className="font-mono text-sm">
                  {loan.loan_id}
                </TableCell>
                <TableCell>{loan.borrower_name}</TableCell>
                <TableCell>
                  <Badge variant="outline" className="text-xs">
                    {loan.product_type}
                  </Badge>
                </TableCell>
                <TableCell className="text-right font-medium">
                  ${(loan.current_balance / 1e6).toFixed(2)}M
                </TableCell>
                <TableCell className="text-right">
                  {loan.interest_rate.toFixed(2)}%
                </TableCell>
                <TableCell>
                  <Badge className={getStatusColor(loan.payment_status)}>
                    {loan.payment_status}
                  </Badge>
                </TableCell>
                <TableCell className="text-slate-600">
                  {new Date(loan.origination_date).toLocaleDateString()}
                </TableCell>
                <TableCell>
                  <ChevronRight className="h-4 w-4 text-slate-400" />
                </TableCell>
              </motion.tr>
            ))}
          </TableBody>
        </Table>
      </div>
    </div>
  )
}
```

### 4. Create Loan Detail Panel (Slide-Out)

```typescript
// components/panels/LoanDetailPanel.tsx
'use client'

import { useState, useEffect } from 'react'
import { X, TrendingUp, AlertCircle, FileText, Activity } from 'lucide-react'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Badge } from '@/components/ui/badge'
import { motion } from 'framer-motion'

interface LoanDetail {
  loan_id: string
  borrower_name: string
  product_type: string
  current_balance: number
  original_amount: number
  interest_rate: number
  origination_date: string
  maturity_date: string
  payment_status: string
  days_past_due: number
  cecl_reserve: number
  pd: number
  lgd: number
  collateral_type: string
  collateral_value: number
  ltv_ratio: number
  officer_id: string
  branch_id: string
  // Related data
  payment_history?: Array<any>
  gl_entries?: Array<any>
  subledger_entries?: Array<any>
}

interface Props {
  loanId: string
  open: boolean
  onClose: () => void
}

export default function LoanDetailPanel({ loanId, open, onClose }: Props) {
  const [loan, setLoan] = useState<LoanDetail | null>(null)
  const [loading, setLoading] = useState(true)
  
  useEffect(() => {
    if (!open || !loanId) return
    
    setLoading(true)
    
    // Fetch comprehensive loan details
    fetch(`/api/data/loan-detail/${loanId}`)
      .then(res => res.json())
      .then(data => {
        setLoan(data)
        setLoading(false)
      })
      .catch(err => {
        console.error('Error loading loan:', err)
        setLoading(false)
      })
  }, [loanId, open])
  
  if (!loan && !loading) return null
  
  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-2xl font-semibold flex items-center gap-3">
            <FileText className="h-6 w-6 text-primary-500" />
            Loan Detail: {loanId}
          </DialogTitle>
        </DialogHeader>
        
        {loading ? (
          <div className="space-y-4 animate-pulse">
            <div className="h-20 bg-slate-200 rounded" />
            <div className="h-40 bg-slate-200 rounded" />
          </div>
        ) : loan ? (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="space-y-6"
          >
            {/* Summary Cards */}
            <div className="grid grid-cols-4 gap-4">
              <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                <p className="text-xs text-slate-600 mb-1">Current Balance</p>
                <p className="text-2xl font-bold text-slate-900">
                  ${(loan.current_balance / 1e6).toFixed(2)}M
                </p>
                <p className="text-xs text-slate-600 mt-1">
                  Orig: ${(loan.original_amount / 1e6).toFixed(2)}M
                </p>
              </div>
              
              <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                <p className="text-xs text-slate-600 mb-1">Interest Rate</p>
                <p className="text-2xl font-bold text-slate-900">
                  {loan.interest_rate.toFixed(2)}%
                </p>
                <p className="text-xs text-slate-600 mt-1">
                  {loan.product_type}
                </p>
              </div>
              
              <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                <p className="text-xs text-slate-600 mb-1">Payment Status</p>
                <Badge className={getStatusColor(loan.payment_status)}>
                  {loan.payment_status}
                </Badge>
                {loan.days_past_due > 0 && (
                  <p className="text-xs text-red-600 mt-2">
                    {loan.days_past_due} days past due
                  </p>
                )}
              </div>
              
              <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                <p className="text-xs text-slate-600 mb-1">CECL Reserve</p>
                <p className="text-2xl font-bold text-slate-900">
                  ${(loan.cecl_reserve / 1e3).toFixed(0)}K
                </p>
                <p className="text-xs text-slate-600 mt-1">
                  {(loan.cecl_reserve / loan.current_balance * 100).toFixed(2)}% of balance
                </p>
              </div>
            </div>
            
            {/* Detailed Tabs */}
            <Tabs defaultValue="overview" className="w-full">
              <TabsList className="grid grid-cols-4 w-full">
                <TabsTrigger value="overview">Overview</TabsTrigger>
                <TabsTrigger value="risk">Risk Profile</TabsTrigger>
                <TabsTrigger value="accounting">Accounting</TabsTrigger>
                <TabsTrigger value="history">History</TabsTrigger>
              </TabsList>
              
              <TabsContent value="overview" className="space-y-4">
                <div className="grid grid-cols-2 gap-6">
                  <div>
                    <h3 className="font-semibold text-slate-900 mb-3">Borrower Information</h3>
                    <dl className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <dt className="text-slate-600">Name:</dt>
                        <dd className="font-medium">{loan.borrower_name}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="text-slate-600">Relationship Officer:</dt>
                        <dd className="font-medium font-mono">{loan.officer_id}</dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="text-slate-600">Branch:</dt>
                        <dd className="font-medium font-mono">{loan.branch_id}</dd>
                      </div>
                    </dl>
                  </div>
                  
                  <div>
                    <h3 className="font-semibold text-slate-900 mb-3">Loan Terms</h3>
                    <dl className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <dt className="text-slate-600">Origination:</dt>
                        <dd className="font-medium">
                          {new Date(loan.origination_date).toLocaleDateString()}
                        </dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="text-slate-600">Maturity:</dt>
                        <dd className="font-medium">
                          {new Date(loan.maturity_date).toLocaleDateString()}
                        </dd>
                      </div>
                      <div className="flex justify-between">
                        <dt className="text-slate-600">Original Amount:</dt>
                        <dd className="font-medium">
                          ${(loan.original_amount / 1e6).toFixed(2)}M
                        </dd>
                      </div>
                    </dl>
                  </div>
                </div>
                
                <div>
                  <h3 className="font-semibold text-slate-900 mb-3">Collateral</h3>
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="text-sm text-slate-600">Type</p>
                        <p className="font-medium">{loan.collateral_type}</p>
                      </div>
                      <div className="text-right">
                        <p className="text-sm text-slate-600">Value</p>
                        <p className="font-medium">
                          ${(loan.collateral_value / 1e6).toFixed(2)}M
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="text-sm text-slate-600">LTV Ratio</p>
                        <p className="font-medium">
                          {(loan.ltv_ratio * 100).toFixed(1)}%
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </TabsContent>
              
              <TabsContent value="risk" className="space-y-4">
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-6">
                  <h3 className="font-semibold text-slate-900 mb-4 flex items-center gap-2">
                    <AlertCircle className="h-5 w-5 text-amber-500" />
                    CECL Risk Parameters
                  </h3>
                  
                  <div className="grid grid-cols-3 gap-6">
                    <div>
                      <p className="text-sm text-slate-600 mb-2">Probability of Default (PD)</p>
                      <div className="flex items-baseline gap-2">
                        <p className="text-3xl font-bold text-slate-900">
                          {(loan.pd * 100).toFixed(2)}%
                        </p>
                      </div>
                      <div className="mt-2 h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div 
                          className="h-full bg-amber-500"
                          style={{ width: `${loan.pd * 100}%` }}
                        />
                      </div>
                    </div>
                    
                    <div>
                      <p className="text-sm text-slate-600 mb-2">Loss Given Default (LGD)</p>
                      <div className="flex items-baseline gap-2">
                        <p className="text-3xl font-bold text-slate-900">
                          {(loan.lgd * 100).toFixed(1)}%
                        </p>
                      </div>
                      <div className="mt-2 h-2 bg-slate-200 rounded-full overflow-hidden">
                        <div 
                          className="h-full bg-red-500"
                          style={{ width: `${loan.lgd * 100}%` }}
                        />
                      </div>
                    </div>
                    
                    <div>
                      <p className="text-sm text-slate-600 mb-2">CECL Reserve</p>
                      <div className="flex items-baseline gap-2">
                        <p className="text-3xl font-bold text-slate-900">
                          ${(loan.cecl_reserve / 1e3).toFixed(0)}K
                        </p>
                      </div>
                      <p className="text-xs text-slate-600 mt-2">
                        {(loan.cecl_reserve / loan.current_balance * 100).toFixed(3)}% of balance
                      </p>
                    </div>
                  </div>
                  
                  <div className="mt-6 pt-4 border-t border-slate-300">
                    <p className="text-xs text-slate-600">
                      <strong>Formula:</strong> CECL Reserve = EAD × PD × LGD
                    </p>
                    <p className="text-xs text-slate-600 mt-1">
                      = ${(loan.current_balance / 1e6).toFixed(2)}M × {(loan.pd * 100).toFixed(2)}% × {(loan.lgd * 100).toFixed(1)}% 
                      = ${(loan.cecl_reserve / 1e3).toFixed(0)}K
                    </p>
                  </div>
                </div>
              </TabsContent>
              
              <TabsContent value="accounting" className="space-y-4">
                <h3 className="font-semibold text-slate-900 mb-3">GL Entries for This Loan</h3>
                
                {loan.gl_entries && loan.gl_entries.length > 0 ? (
                  <div className="space-y-2">
                    {loan.gl_entries.map((entry: any, index: number) => (
                      <div key={index} className="bg-white border border-slate-200 rounded-lg p-4">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <p className="font-mono text-sm font-medium">{entry.entry_id}</p>
                            <p className="text-xs text-slate-600">
                              {new Date(entry.entry_date).toLocaleDateString()}
                            </p>
                          </div>
                          <Badge variant={entry.is_balanced ? 'success' : 'destructive'}>
                            {entry.is_balanced ? 'Balanced' : 'Unbalanced'}
                          </Badge>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-4 text-sm">
                          <div>
                            <p className="text-slate-600">Total Debits:</p>
                            <p className="font-medium">
                              ${(entry.total_debits / 1e6).toFixed(2)}M
                            </p>
                          </div>
                          <div>
                            <p className="text-slate-600">Total Credits:</p>
                            <p className="font-medium">
                              ${(entry.total_credits / 1e6).toFixed(2)}M
                            </p>
                          </div>
                        </div>
                        
                        <p className="text-xs text-slate-600 mt-3">{entry.description}</p>
                        
                        {/* Clickable to see GL detail */}
                        <button
                          onClick={() => {
                            // Drill down to GL entry detail
                            // Could open another modal or navigate
                          }}
                          className="mt-3 text-xs text-primary-600 hover:text-primary-700 font-medium"
                        >
                          View GL Entry Details →
                        </button>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-sm text-slate-600">No GL entries found</p>
                )}
                
                <h3 className="font-semibold text-slate-900 mb-3 mt-6">Subledger Transactions</h3>
                
                {loan.subledger_entries && loan.subledger_entries.length > 0 ? (
                  <div className="border border-slate-200 rounded-lg overflow-hidden">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-50">
                        <tr>
                          <th className="text-left p-3 font-medium">Date</th>
                          <th className="text-left p-3 font-medium">Type</th>
                          <th className="text-right p-3 font-medium">Principal</th>
                          <th className="text-right p-3 font-medium">Interest</th>
                          <th className="text-right p-3 font-medium">Balance After</th>
                        </tr>
                      </thead>
                      <tbody>
                        {loan.subledger_entries.map((txn: any, index: number) => (
                          <tr key={index} className="border-t border-slate-100 hover:bg-slate-50">
                            <td className="p-3">
                              {new Date(txn.posting_date).toLocaleDateString()}
                            </td>
                            <td className="p-3">
                              <Badge variant="outline" className="text-xs">
                                {txn.transaction_type}
                              </Badge>
                            </td>
                            <td className="p-3 text-right font-mono">
                              ${(txn.principal_amount / 1e3).toFixed(1)}K
                            </td>
                            <td className="p-3 text-right font-mono">
                              ${(txn.interest_amount / 1e3).toFixed(1)}K
                            </td>
                            <td className="p-3 text-right font-mono font-medium">
                              ${(txn.balance_after / 1e6).toFixed(2)}M
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <p className="text-sm text-slate-600">No subledger entries found</p>
                )}
              </TabsContent>
              
              <TabsContent value="history" className="space-y-4">
                <h3 className="font-semibold text-slate-900 mb-3">Payment History</h3>
                {/* Payment history timeline - could add chart showing payment patterns */}
                <p className="text-sm text-slate-600">Payment history visualization would go here</p>
              </TabsContent>
            </Tabs>
          </motion.div>
        ) : null}
      </DialogContent>
    </Dialog>
  )
}

function getStatusColor(status: string): string {
  const colors: Record<string, string> = {
    'Current': 'bg-green-100 text-green-800 border-green-200',
    'Past_Due_30': 'bg-yellow-100 text-yellow-800 border-yellow-200',
    'Past_Due_60': 'bg-orange-100 text-orange-800 border-orange-200',
    'Past_Due_90': 'bg-red-100 text-red-800 border-red-200',
    'Default': 'bg-red-200 text-red-900 border-red-300'
  }
  return colors[status] || 'bg-slate-100 text-slate-800'
}
```

### 5. Create FastAPI Endpoints for Drill-Down Data

```python
# backend/main.py (add these endpoints)

@app.get("/api/data/loans")
@mlflow.trace(name="api_get_loans", span_type="API")
async def get_loans(
    product_type: str = None,
    days: int = None,
    limit: int = 100
):
    """
    Get loan list with optional filters
    Returns: List of loans matching criteria
    """
    from pyspark.sql import SparkSession
    
    spark = SparkSession.builder \
        .config("spark.databricks.sql.warehouse.id", "4b9b953939869799") \
        .getOrCreate()
    
    # Build query with filters
    where_clauses = ["is_current = true"]
    
    if product_type:
        where_clauses.append(f"product_type = '{product_type}'")
    
    if days:
        where_clauses.append(f"DATEDIFF(CURRENT_DATE(), origination_date) <= {days}")
    
    where_sql = " AND ".join(where_clauses)
    
    query = f"""
        SELECT 
            loan_id,
            borrower_name,
            product_type,
            current_balance,
            interest_rate,
            payment_status,
            origination_date
        FROM cfo_banking_demo.silver_finance.loan_portfolio
        WHERE {where_sql}
        ORDER BY origination_date DESC
        LIMIT {limit}
    """
    
    df = spark.sql(query)
    loans = df.toPandas().to_dict('records')
    
    # Log access for audit
    mlflow.log_param("filter_product_type", product_type or "all")
    mlflow.log_param("records_returned", len(loans))
    
    return {"loans": loans, "count": len(loans)}

@app.get("/api/data/loan-detail/{loan_id}")
@mlflow.trace(name="api_get_loan_detail", span_type="API")
async def get_loan_detail(loan_id: str):
    """
    Get comprehensive loan details with related records
    Returns: Loan info + GL entries + subledger + payment history
    """
    from pyspark.sql import SparkSession
    
    spark = SparkSession.builder \
        .config("spark.databricks.sql.warehouse.id", "4b9b953939869799") \
        .getOrCreate()
    
    # Log access for audit trail
    mlflow.log_param("loan_id_accessed", loan_id)
    mlflow.log_param("accessed_by", "pravin.varma@databricks.com")
    
    # Get loan details
    loan_query = f"""
        SELECT *
        FROM cfo_banking_demo.silver_finance.loan_portfolio
        WHERE loan_id = '{loan_id}'
        AND is_current = true
    """
    
    loan_df = spark.sql(loan_query)
    
    if loan_df.count() == 0:
        return {"error": "Loan not found"}
    
    loan = loan_df.toPandas().to_dict('records')[0]
    
    # Get related GL entries
    gl_query = f"""
        SELECT *
        FROM cfo_banking_demo.silver_finance.gl_entries
        WHERE source_transaction_id LIKE '%{loan_id}%'
        ORDER BY entry_timestamp DESC
    """
    
    gl_df = spark.sql(gl_query)
    gl_entries = gl_df.toPandas().to_dict('records') if gl_df.count() > 0 else []
    
    # Get subledger transactions
    subledger_query = f"""
        SELECT *
        FROM cfo_banking_demo.silver_finance.loan_subledger
        WHERE loan_id = '{loan_id}'
        ORDER BY transaction_timestamp DESC
    """
    
    subledger_df = spark.sql(subledger_query)
    subledger_entries = subledger_df.toPandas().to_dict('records') if subledger_df.count() > 0 else []
    
    # Combine all data
    result = {
        **loan,
        "gl_entries": gl_entries,
        "subledger_entries": subledger_entries,
        "payment_history": []  # Could add payment history if available
    }
    
    # Log what was retrieved
    mlflow.log_metric("gl_entries_count", len(gl_entries))
    mlflow.log_metric("subledger_entries_count", len(subledger_entries))
    
    return result

@app.get("/api/data/deposits")
@mlflow.trace(name="api_get_deposits", span_type="API")
async def get_deposits(
    product_type: str = None,
    customer_segment: str = None,
    limit: int = 100
):
    """Get deposit accounts with filters"""
    from pyspark.sql import SparkSession
    
    spark = SparkSession.builder \
        .config("spark.databricks.sql.warehouse.id", "4b9b953939869799") \
        .getOrCreate()
    
    where_clauses = ["is_current = true"]
    
    if product_type:
        where_clauses.append(f"product_type = '{product_type}'")
    
    if customer_segment:
        where_clauses.append(f"customer_segment = '{customer_segment}'")
    
    where_sql = " AND ".join(where_clauses)
    
    query = f"""
        SELECT 
            account_id,
            customer_name,
            product_type,
            customer_segment,
            current_balance,
            stated_rate,
            beta,
            account_status
        FROM cfo_banking_demo.silver_treasury.deposit_portfolio
        WHERE {where_sql}
        ORDER BY current_balance DESC
        LIMIT {limit}
    """
    
    df = spark.sql(query)
    deposits = df.toPandas().to_dict('records')
    
    return {"deposits": deposits, "count": len(deposits)}

@app.get("/api/data/securities")
@mlflow.trace(name="api_get_securities", span_type="API")
async def get_securities(
    security_type: str = None,
    hqla_level: str = None,
    limit: int = 100
):
    """Get securities portfolio with filters"""
    from pyspark.sql import SparkSession
    
    spark = SparkSession.builder \
        .config("spark.databricks.sql.warehouse.id", "4b9b953939869799") \
        .getOrCreate()
    
    # Build filters
    where_clauses = ["is_current = true"]
    
    if security_type:
        where_clauses.append(f"security_type = '{security_type}'")
    
    where_sql = " AND ".join(where_clauses)
    
    # If HQLA filter, join with HQLA table
    if hqla_level:
        query = f"""
            SELECT 
                s.security_id,
                s.issuer_name,
                s.security_type,
                s.maturity_date,
                s.market_value,
                s.yield_to_maturity,
                s.duration,
                h.hqla_level,
                h.hqla_value
            FROM cfo_banking_demo.silver_treasury.securities_portfolio s
            JOIN cfo_banking_demo.gold_regulatory.hqla_inventory h
                ON s.security_id = h.security_id
            WHERE {where_sql}
            AND h.hqla_level = '{hqla_level}'
            ORDER BY s.market_value DESC
            LIMIT {limit}
        """
    else:
        query = f"""
            SELECT 
                security_id,
                issuer_name,
                security_type,
                maturity_date,
                market_value,
                yield_to_maturity,
                duration,
                credit_rating
            FROM cfo_banking_demo.silver_treasury.securities_portfolio
            WHERE {where_sql}
            ORDER BY market_value DESC
            LIMIT {limit}
        """
    
    df = spark.sql(query)
    securities = df.toPandas().to_dict('records')
    
    return {"securities": securities, "count": len(securities)}
```

### 6. Create Main View Switcher Component

```typescript
// app/page.tsx (updated with drill-down)
'use client'

import { DrillDownProvider, useDrillDown } from '@/lib/drill-down-context'
import Breadcrumbs from '@/components/Breadcrumbs'
import Dashboard from '@/components/views/Dashboard'
import LoanTable from '@/components/tables/LoanTable'
import DepositTable from '@/components/tables/DepositTable'
import SecuritiesTable from '@/components/tables/SecuritiesTable'
import LoanDetailPanel from '@/components/panels/LoanDetailPanel'

function AppContent() {
  const { state } = useDrillDown()
  const [selectedLoan, setSelectedLoan] = useState<string | null>(null)
  
  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      {/* Header */}
      <header className="border-b border-slate-200 bg-white/80 backdrop-blur-md sticky top-0 z-50">
        <div className="container mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-semibold text-slate-900">
                CFO Platform
              </h1>
              <p className="text-sm text-slate-600">
                Databricks Financial Services
              </p>
            </div>
          </div>
        </div>
      </header>
      
      {/* Breadcrumbs */}
      <div className="container mx-auto px-6 pt-6">
        <Breadcrumbs />
      </div>
      
      {/* Main Content - View Switcher */}
      <main className="container mx-auto px-6 py-6">
        {state.view === 'dashboard' && <Dashboard />}
        {state.view === 'loan-table' && <LoanTable filters={state.filters} />}
        {state.view === 'deposit-table' && <DepositTable filters={state.filters} />}
        {state.view === 'securities-table' && <SecuritiesTable filters={state.filters} />}
      </main>
      
      {/* Loan Detail Panel (Modal) */}
      {selectedLoan && (
        <LoanDetailPanel
          loanId={selectedLoan}
          open={!!selectedLoan}
          onClose={() => setSelectedLoan(null)}
        />
      )}
    </div>
  )
}

export default function Page() {
  return (
    <DrillDownProvider>
      <AppContent />
    </DrillDownProvider>
  )
}
```

## Drill-Down Patterns

### Pattern 1: Click Chart to See Data

**Dashboard Chart → Data Table**
```typescript
// In YieldCurveChart component
<Area 
  onClick={(data) => {
    // Clicked on a specific point
    navigateTo('yield-history', { maturity: data.maturity })
  }}
/>
```

### Pattern 2: Click Table Row to See Detail

**Loan List → Loan Detail Panel**
```typescript
// In LoanTable component
<TableRow 
  onClick={() => setSelectedLoan(loan.loan_id)}
  className="cursor-pointer hover:bg-slate-50"
>
```

### Pattern 3: Click Metric to See Breakdown

**KPI Card → Detailed View**
```typescript
// In MetricCard component
<Card 
  onClick={() => navigateTo('asset-breakdown')}
  className="cursor-pointer hover:shadow-lg transition-shadow"
>
```

### Pattern 4: Filter and Navigate

**Filter UI → Filtered View**
```typescript
<button
  onClick={() => navigateTo('loan-table', { product_type: 'Consumer_Auto' })}
>
  Auto Loans
</button>
```

## Success Criteria

- [ ] All tables are clickable (rows drill down to detail)
- [ ] All charts are interactive (click points to see data)
- [ ] All metrics cards are clickable (drill to breakdown)
- [ ] Breadcrumb navigation works
- [ ] Back button returns to previous view
- [ ] Filters persist across drill-downs
- [ ] Detail panels show comprehensive data
- [ ] Can drill down 3-4 levels deep
- [ ] Smooth transitions between views
- [ ] Loading states for all data fetches
- [ ] All drill-downs traced with MLflow

## Example User Flows

**Flow 1: Executive → Loan Detail**
```
Dashboard
  ↓ (click "Recent Activity" card)
Recent Loans Table (all products)
  ↓ (click "Auto Loans" filter)
Auto Loan Table (48,000 filtered to 100 displayed)
  ↓ (click loan LOAN-AUTO-012345)
Loan Detail Panel
  ├─ Overview tab: Borrower info, terms
  ├─ Risk tab: CECL breakdown, PD/LGD
  ├─ Accounting tab: GL entries, subledger
  └─ History tab: Payment timeline
```

**Flow 2: Treasury Analysis**
```
Dashboard  
  ↓ (click "Securities $2.8B" metric)
Securities Portfolio Table
  ↓ (filter: HQLA Level 1)
Level 1 Securities (500 Treasuries)
  ↓ (click specific bond: CUSIP 912828YK0)
Security Detail Panel
  ├─ Bond characteristics
  ├─ Price history chart
  ├─ HQLA classification
  └─ Contributing to LCR
```

**Flow 3: Liquidity Deep Dive**
```
Dashboard
  ↓ (click LCR gauge showing 104.9%)
LCR Breakdown View
  ├─ HQLA composition table (clickable)
  ├─ Cash outflows by deposit type (clickable)
  └─ Cash inflows by loan type (clickable)
      ↓ (click "Commercial RE inflows")
Maturing Commercial RE Loans (next 30 days)
      ↓ (click specific loan)
Loan Detail showing maturity impact
```

## MLflow Tracing for Drill-Downs

Every navigation is traced:

```python
@mlflow.trace(name="user_navigation", span_type="INTERACTION")
def track_navigation(from_view: str, to_view: str, filters: dict):
    mlflow.log_param("from_view", from_view)
    mlflow.log_param("to_view", to_view)
    mlflow.log_param("filters_applied", json.dumps(filters))
    mlflow.log_param("timestamp", datetime.now().isoformat())
```

This creates an audit trail of user exploration:
- What did they look at?
- What filters did they apply?
- How deep did they drill?
- What data did they access?

## Estimated Duration
⏱️ 4-6 hours (adding comprehensive interactivity to existing React app)

## When Complete
You'll have a fully interactive, explorable data platform where executives can:
- Start at high-level overview
- Click anything to drill deeper
- Explore underlying data intuitively
- Navigate back easily with breadcrumbs
- All interactions logged for audit

This is enterprise-grade BI meets modern SaaS UX.

Begin execution now.
